"use strict";(self.webpackChunkprofilebook_frontend=self.webpackChunkprofilebook_frontend||[]).push([[530],{9530:(D,d,a)=>{a.r(d),a.d(d,{ChatComponent:()=>$});var m=a(177),g=a(4341),h=a(3888),u=a(1985),p=a(9470);var e=a(4438),f=a(2183),M=a(4537),_=a(9885),x=a(4796);const I=["messagesContainer"];function k(t,i){if(1&t&&(e.j41(0,"div",19)(1,"h5",26),e.EFF(2),e.k0s(),e.j41(3,"small",27),e.EFF(4),e.k0s()()),2&t){const s=e.XpG();e.R7$(2),e.Lme("",s.otherUser.firstName," ",s.otherUser.lastName,""),e.R7$(2),e.JRh("@"+s.otherUser.userName)}}function y(t,i){1&t&&e.nrm(0,"div",28)}function S(t,i){1&t&&(e.j41(0,"div",29)(1,"div",30)(2,"span",31),e.EFF(3,"Loading messages..."),e.k0s()(),e.j41(4,"p",32),e.EFF(5,"Loading conversation..."),e.k0s()())}function F(t,i){1&t&&(e.j41(0,"div",33),e.nrm(1,"i",34),e.j41(2,"h5",27),e.EFF(3,"No messages yet"),e.k0s(),e.j41(4,"p",27),e.EFF(5,"Start the conversation by sending a message"),e.k0s()())}function U(t,i){1&t&&e.nrm(0,"i",43)}function T(t,i){1&t&&e.nrm(0,"i",44)}function P(t,i){if(1&t&&(e.j41(0,"div",37)(1,"div",38)(2,"p",39),e.EFF(3),e.k0s(),e.j41(4,"small",40),e.EFF(5),e.DNE(6,U,1,0,"i",41)(7,T,1,0,"i",42),e.k0s()()()),2&t){const s=i.$implicit,n=e.XpG(2);e.AVh("sent",s.senderId===n.currentUserId)("received",s.senderId!==n.currentUserId),e.R7$(3),e.JRh(s.messageContent),e.R7$(2),e.SpI(" ",n.formatMessageTime(s.timeStamp)," "),e.R7$(),e.Y8G("ngIf",s.senderId===n.currentUserId&&s.isRead),e.R7$(),e.Y8G("ngIf",s.senderId===n.currentUserId&&!s.isRead)}}function R(t,i){if(1&t&&(e.j41(0,"div",35),e.DNE(1,P,8,8,"div",36),e.k0s()),2&t){const s=e.XpG();e.R7$(),e.Y8G("ngForOf",s.messages)}}function L(t,i){1&t&&e.nrm(0,"span",48)}function j(t,i){if(1&t){const s=e.RV6();e.j41(0,"div",45)(1,"button",46),e.bIt("click",function(){e.eBV(s);const r=e.XpG();return e.Njj(r.loadMoreMessages())}),e.DNE(2,L,1,0,"span",47),e.EFF(3),e.k0s()()}if(2&t){const s=e.XpG();e.R7$(),e.Y8G("disabled",s.isLoadingMore),e.R7$(),e.Y8G("ngIf",s.isLoadingMore),e.R7$(),e.SpI(" ",s.isLoadingMore?"Loading...":"Load Earlier Messages"," ")}}function w(t,i){1&t&&(e.j41(0,"div",49),e.EFF(1," Message cannot be empty or exceed 1000 characters "),e.k0s())}function G(t,i){1&t&&e.nrm(0,"span",50)}function O(t,i){1&t&&e.nrm(0,"i",51)}function E(t,i){if(1&t){const s=e.RV6();e.j41(0,"div",52),e.nrm(1,"i",53),e.EFF(2),e.j41(3,"button",54),e.bIt("click",function(){e.eBV(s);const r=e.XpG();return e.Njj(r.errorMessage="")}),e.k0s()()}if(2&t){const s=e.XpG();e.R7$(2),e.SpI("",s.errorMessage," ")}}let $=(()=>{class t{constructor(s,n,r,o,c,l){this.fb=s,this.route=n,this.router=r,this.messageService=o,this.userService=c,this.authService=l,this.messages=[],this.otherUser=null,this.currentUserId=null,this.otherUserId="",this.isLoadingMessages=!1,this.isLoadingUser=!1,this.isLoadingMore=!1,this.isSending=!1,this.hasMoreMessages=!1,this.currentPage=1,this.pageSize=50,this.errorMessage="",this.shouldScrollToBottom=!1,this.messageForm=this.fb.group({messageContent:["",[g.k0.required,g.k0.maxLength(1e3)]]})}ngOnInit(){this.currentUserId=this.authService.getCurrentUser()?.id||null,this.route.params.subscribe(s=>{this.otherUserId=s.userId,this.otherUserId&&(this.loadUser(),this.loadMessages(),this.startMessageRefresh())})}ngOnDestroy(){this.refreshSubscription&&this.refreshSubscription.unsubscribe()}ngAfterViewChecked(){this.shouldScrollToBottom&&(this.scrollToBottom(),this.shouldScrollToBottom=!1)}loadUser(){this.isLoadingUser=!0,this.userService.getUser(this.otherUserId).subscribe({next:s=>{this.otherUser=s,this.isLoadingUser=!1},error:s=>{this.isLoadingUser=!1,this.errorMessage="Failed to load user information.",console.error("Error loading user:",s)}})}loadMessages(){this.isLoadingMessages=!0,this.messageService.getConversation(this.otherUserId,1,this.pageSize).subscribe({next:s=>{this.messages=s.reverse(),this.isLoadingMessages=!1,this.hasMoreMessages=s.length===this.pageSize,this.currentPage=1,this.shouldScrollToBottom=!0},error:s=>{this.isLoadingMessages=!1,this.errorMessage="Failed to load messages. Please try again.",console.error("Error loading messages:",s)}})}loadMoreMessages(){if(!this.isLoadingMore&&this.hasMoreMessages){this.isLoadingMore=!0;const s=this.currentPage+1;this.messageService.getConversation(this.otherUserId,s,this.pageSize).subscribe({next:n=>{const r=n.reverse();this.messages=[...r,...this.messages],this.isLoadingMore=!1,this.hasMoreMessages=n.length===this.pageSize,this.currentPage=s},error:n=>{this.isLoadingMore=!1,this.errorMessage="Failed to load more messages.",console.error("Error loading more messages:",n)}})}}sendMessage(){if(this.messageForm.valid){this.isSending=!0,this.errorMessage="";const s={receiverId:this.otherUserId,messageContent:this.messageForm.get("messageContent")?.value.trim()};this.messageService.sendMessage(s).subscribe({next:n=>{this.messages.push(n),this.messageForm.reset(),this.isSending=!1,this.shouldScrollToBottom=!0},error:n=>{this.isSending=!1,this.errorMessage=n.error?.message||"Failed to send message. Please try again.",console.error("Error sending message:",n)}})}else this.markFormGroupTouched()}onKeyPress(s){"Enter"===s.key&&!s.shiftKey&&(s.preventDefault(),this.sendMessage())}goBack(){this.router.navigate(["/messages"])}getUserAvatar(){return this.otherUser?.profileImagePath?this.otherUser.profileImagePath:"https://via.placeholder.com/48x48/3b82f6/ffffff?text="+(this.otherUser?.firstName?.charAt(0)||this.otherUser?.userName?.charAt(0)||"U")}formatMessageTime(s){const n=new Date(s),r=new Date;return n.toDateString()===r.toDateString()?n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):Math.floor((r.getTime()-n.getTime())/864e5)<7?n.toLocaleDateString([],{weekday:"short"})+" "+n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):n.toLocaleDateString()+" "+n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}startMessageRefresh(){this.refreshSubscription=function C(t=0,i=h.E){return t<0&&(t=0),function v(t=0,i,s=h.b){let n=-1;return null!=i&&((0,p.m)(i)?s=i:n=i),new u.c(r=>{let o=function b(t){return t instanceof Date&&!isNaN(t)}(t)?+t-s.now():t;o<0&&(o=0);let c=0;return s.schedule(function(){r.closed||(r.next(c++),0<=n?this.schedule(void 0,n):r.complete())},o)})}(t,t,i)}(3e4).subscribe(()=>{!this.isLoadingMessages&&!this.isSending&&this.refreshMessages()})}refreshMessages(){this.messageService.getConversation(this.otherUserId,1,this.pageSize).subscribe({next:s=>{const n=s.reverse();n.length-this.messages.length>0&&(this.messages=n,this.shouldScrollToBottom=!0)},error:s=>{console.error("Error refreshing messages:",s)}})}scrollToBottom(){try{const s=this.messagesContainer.nativeElement;s.scrollTop=s.scrollHeight}catch(s){console.error("Error scrolling to bottom:",s)}}isFieldInvalid(s){const n=this.messageForm.get(s);return!(!n||!n.invalid||!n.dirty&&!n.touched)}markFormGroupTouched(){Object.keys(this.messageForm.controls).forEach(s=>{this.messageForm.get(s)?.markAsTouched()})}static{this.\u0275fac=function(n){return new(n||t)(e.rXU(g.ok),e.rXU(f.nX),e.rXU(f.Ix),e.rXU(M.b),e.rXU(_.D),e.rXU(x.u))}}static{this.\u0275cmp=e.VBU({type:t,selectors:[["app-chat"]],viewQuery:function(n,r){if(1&n&&e.GBs(I,5),2&n){let o;e.mGM(o=e.lsd())&&(r.messagesContainer=o.first)}},standalone:!0,features:[e.aNF],decls:26,vars:15,consts:[["messagesContainer",""],[1,"container-fluid","h-100"],[1,"row","h-100"],[1,"col-12"],[1,"chat-container","d-flex","flex-column","h-100"],[1,"chat-header","bg-white","border-bottom","p-3","shadow-sm"],[1,"d-flex","align-items-center"],[1,"btn","btn-outline-secondary","me-3",3,"click"],[1,"fas","fa-arrow-left"],["width","48","height","48","alt","User avatar",1,"rounded-circle","me-3",3,"src"],["class","flex-grow-1",4,"ngIf"],["class","spinner-border spinner-border-sm text-primary",4,"ngIf"],[1,"messages-container","flex-grow-1","p-3"],["class","text-center py-4",4,"ngIf"],["class","text-center py-5",4,"ngIf"],["class","messages-list",4,"ngIf"],["class","text-center mb-3",4,"ngIf"],[1,"message-input","bg-white","border-top","p-3"],[1,"d-flex","gap-2",3,"ngSubmit","formGroup"],[1,"flex-grow-1"],["type","text","formControlName","messageContent","placeholder","Type your message...",1,"form-control",3,"keypress"],["class","invalid-feedback",4,"ngIf"],["type","submit",1,"btn","btn-primary",3,"disabled"],["class","spinner-border spinner-border-sm",4,"ngIf"],["class","fas fa-paper-plane",4,"ngIf"],["class","alert alert-danger m-3",4,"ngIf"],[1,"mb-0"],[1,"text-muted"],[1,"spinner-border","spinner-border-sm","text-primary"],[1,"text-center","py-4"],["role","status",1,"spinner-border","text-primary"],[1,"visually-hidden"],[1,"mt-2","text-muted"],[1,"text-center","py-5"],[1,"fas","fa-comments","fa-3x","text-muted","mb-3"],[1,"messages-list"],["class","message mb-3",3,"sent","received",4,"ngFor","ngForOf"],[1,"message","mb-3"],[1,"message-bubble"],[1,"mb-1"],[1,"message-time"],["class","fas fa-check-double ms-1 text-primary",4,"ngIf"],["class","fas fa-check ms-1",4,"ngIf"],[1,"fas","fa-check-double","ms-1","text-primary"],[1,"fas","fa-check","ms-1"],[1,"text-center","mb-3"],[1,"btn","btn-outline-primary","btn-sm",3,"click","disabled"],["class","spinner-border spinner-border-sm me-2",4,"ngIf"],[1,"spinner-border","spinner-border-sm","me-2"],[1,"invalid-feedback"],[1,"spinner-border","spinner-border-sm"],[1,"fas","fa-paper-plane"],[1,"alert","alert-danger","m-3"],[1,"fas","fa-exclamation-triangle","me-2"],["type","button",1,"btn-close",3,"click"]],template:function(n,r){if(1&n){const o=e.RV6();e.j41(0,"div",1)(1,"div",2)(2,"div",3)(3,"div",4)(4,"div",5)(5,"div",6)(6,"button",7),e.bIt("click",function(){return e.eBV(o),e.Njj(r.goBack())}),e.nrm(7,"i",8),e.k0s(),e.nrm(8,"img",9),e.DNE(9,k,5,3,"div",10)(10,y,1,0,"div",11),e.k0s()(),e.j41(11,"div",12,0),e.DNE(13,S,6,0,"div",13)(14,F,6,0,"div",14)(15,R,2,1,"div",15)(16,j,4,3,"div",16),e.k0s(),e.j41(17,"div",17)(18,"form",18),e.bIt("ngSubmit",function(){return e.eBV(o),e.Njj(r.sendMessage())}),e.j41(19,"div",19)(20,"input",20),e.bIt("keypress",function(l){return e.eBV(o),e.Njj(r.onKeyPress(l))}),e.k0s(),e.DNE(21,w,2,0,"div",21),e.k0s(),e.j41(22,"button",22),e.DNE(23,G,1,0,"span",23)(24,O,1,0,"i",24),e.k0s()()(),e.DNE(25,E,4,1,"div",25),e.k0s()()()()}2&n&&(e.R7$(8),e.Y8G("src",r.getUserAvatar(),e.B4B),e.R7$(),e.Y8G("ngIf",r.otherUser),e.R7$(),e.Y8G("ngIf",r.isLoadingUser),e.R7$(3),e.Y8G("ngIf",r.isLoadingMessages),e.R7$(),e.Y8G("ngIf",!r.isLoadingMessages&&0===r.messages.length),e.R7$(),e.Y8G("ngIf",!r.isLoadingMessages&&r.messages.length>0),e.R7$(),e.Y8G("ngIf",r.hasMoreMessages&&!r.isLoadingMessages),e.R7$(2),e.Y8G("formGroup",r.messageForm),e.R7$(2),e.AVh("is-invalid",r.isFieldInvalid("messageContent")),e.R7$(),e.Y8G("ngIf",r.isFieldInvalid("messageContent")),e.R7$(),e.Y8G("disabled",r.messageForm.invalid||r.isSending),e.R7$(),e.Y8G("ngIf",r.isSending),e.R7$(),e.Y8G("ngIf",!r.isSending),e.R7$(),e.Y8G("ngIf",r.errorMessage))},dependencies:[m.MD,m.Sq,m.bT,g.X1,g.qT,g.me,g.BC,g.cb,g.j4,g.JD],styles:[".chat-container[_ngcontent-%COMP%]{height:calc(100vh - 80px);max-height:calc(100vh - 80px)}.chat-header[_ngcontent-%COMP%]{flex-shrink:0;z-index:10}.messages-container[_ngcontent-%COMP%]{overflow-y:auto;background-color:#f8f9fa;flex-grow:1;display:flex;flex-direction:column}.messages-list[_ngcontent-%COMP%]{flex-grow:1;display:flex;flex-direction:column;justify-content:flex-end}.message[_ngcontent-%COMP%]{max-width:70%;word-wrap:break-word}.message.sent[_ngcontent-%COMP%]{align-self:flex-end;text-align:right}.message.received[_ngcontent-%COMP%]{align-self:flex-start;text-align:left}.message-bubble[_ngcontent-%COMP%]{display:inline-block;padding:.75rem 1rem;border-radius:1.25rem;word-wrap:break-word;max-width:100%}.message.sent[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{background-color:var(--primary-color);color:#fff;border-bottom-right-radius:.25rem}.message.received[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{background-color:#fff;color:var(--text-primary);border:1px solid var(--border-color);border-bottom-left-radius:.25rem}.message-time[_ngcontent-%COMP%]{opacity:.8;font-size:.75rem}.message.sent[_ngcontent-%COMP%]   .message-time[_ngcontent-%COMP%]{color:#fffc}.message.received[_ngcontent-%COMP%]   .message-time[_ngcontent-%COMP%]{color:var(--text-secondary)}.message-input[_ngcontent-%COMP%]{flex-shrink:0;box-shadow:0 -2px 4px #0000001a}.form-control[_ngcontent-%COMP%]:focus{border-color:var(--primary-color);box-shadow:0 0 0 .2rem #3b82f640}@media (max-width: 768px){.chat-container[_ngcontent-%COMP%]{height:calc(100vh - 70px)}.message[_ngcontent-%COMP%]{max-width:85%}.chat-header[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{padding:.375rem .5rem}.rounded-circle[_ngcontent-%COMP%]{width:40px!important;height:40px!important}}.messages-container[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px}.messages-container[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:#f1f1f1}.messages-container[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:3px}.messages-container[_ngcontent-%COMP%]::-webkit-scrollbar-thumb:hover{background:#a8a8a8}"]})}}return t})()}}]);